# `think settle:orders` å‘½ä»¤æ‰§è¡Œæµç¨‹è¯¦è§£

## ğŸ“ æ‰§è¡Œæµç¨‹å›¾

```
å‘½ä»¤è¡Œæ‰§è¡Œ
    â†“
think å…¥å£æ–‡ä»¶
    â†“
App ç±»åˆå§‹åŒ–
    â†“
Console ç±»åŠ è½½å‘½ä»¤
    â†“
æŸ¥æ‰¾å¹¶æ‰§è¡Œ settle:orders å‘½ä»¤
    â†“
SettleOrders::execute() æ–¹æ³•æ‰§è¡Œ
```

---

## ğŸ” è¯¦ç»†æ‰§è¡Œæ­¥éª¤

### 1. **å…¥å£æ–‡ä»¶**

**æ–‡ä»¶ä½ç½®ï¼š** `nft/think`

```1:10:nft/think
#!/usr/bin/env php
<?php
namespace think;

// å‘½ä»¤è¡Œå…¥å£æ–‡ä»¶
// åŠ è½½åŸºç¡€æ–‡ä»¶
require __DIR__ . '/vendor/autoload.php';

// åº”ç”¨åˆå§‹åŒ–
(new App())->console->run();
```

**è¯´æ˜ï¼š**
- è¿™æ˜¯å‘½ä»¤è¡Œçš„å…¥å£ç‚¹
- åŠ è½½ Composer è‡ªåŠ¨åŠ è½½æ–‡ä»¶
- åˆ›å»º App å®ä¾‹ï¼Œè·å– console å±æ€§ï¼Œè°ƒç”¨ `run()` æ–¹æ³•

---

### 2. **å‘½ä»¤æ³¨å†Œé…ç½®**

**æ–‡ä»¶ä½ç½®ï¼š** `nft/config/console.php`

```1:10:nft/config/console.php
<?php
// +----------------------------------------------------------------------
// | æ§åˆ¶å°é…ç½®
// +----------------------------------------------------------------------
return [
    // æŒ‡ä»¤å®šä¹‰
    'commands' => [
        'settle:orders' => \app\command\SettleOrders::class,
    ],
];
```

**è¯´æ˜ï¼š**
- è¿™é‡Œå®šä¹‰äº†è‡ªå®šä¹‰å‘½ä»¤
- `'settle:orders'` æ˜¯å‘½ä»¤åç§°
- `\app\command\SettleOrders::class` æ˜¯å‘½ä»¤ç±»çš„å®Œæ•´ç±»å

---

### 3. **Console ç±»åŠ è½½å‘½ä»¤**

**æ–‡ä»¶ä½ç½®ï¼š** `nft/vendor/topthink/framework/src/think/Console.php`

#### 3.1 æ„é€ å‡½æ•°

```87:103:nft/vendor/topthink/framework/src/think/Console.php
public function __construct(protected App $app)
{
    $this->initialize();

    $this->definition = $this->getDefaultInputDefinition();

    //åŠ è½½æŒ‡ä»¤
    $this->loadCommands();

    // è®¾ç½®æ‰§è¡Œç”¨æˆ·
    $user = $this->app->config->get('console.user');
    if (!empty($user)) {
        $this->setUser($user);
    }

    $this->start();
}
```

#### 3.2 loadCommands() æ–¹æ³•

```208:214:nft/vendor/topthink/framework/src/think/Console.php
protected function loadCommands(): void
{
    $commands = $this->app->config->get('console.commands', []);
    $commands = array_merge($this->defaultCommands, $commands);

    $this->addCommands($commands);
}
```

**è¯´æ˜ï¼š**
- ä»é…ç½®æ–‡ä»¶è¯»å– `console.commands`
- åˆå¹¶é»˜è®¤å‘½ä»¤å’Œè‡ªå®šä¹‰å‘½ä»¤
- è°ƒç”¨ `addCommands()` æ³¨å†Œæ‰€æœ‰å‘½ä»¤

#### 3.3 addCommands() æ–¹æ³•

```388:396:nft/vendor/topthink/framework/src/think/Console.php
public function addCommands(array $commands): void
{
    foreach ($commands as $key => $command) {
        if (is_subclass_of($command, Command::class)) {
            // æ³¨å†ŒæŒ‡ä»¤
            $this->addCommand($command, is_numeric($key) ? '' : $key);
        }
    }
}
```

#### 3.4 addCommand() æ–¹æ³•

```405:436:nft/vendor/topthink/framework/src/think/Console.php
public function addCommand(string|Command $command, string $name = '')
{
    if ($name) {
        $this->commands[$name] = $command;
        return;
    }

    if (is_string($command)) {
        $command = $this->app->invokeClass($command);
    }

    $command->setConsole($this);

    if (!$command->isEnabled()) {
        $command->setConsole(null);
        return;
    }

    $command->setApp($this->app);

    if (null === $command->getDefinition()) {
        throw new LogicException(sprintf('Command class "%s" is not correctly initialized. You probably forgot to call the parent constructor.', $command::class));
    }

    $this->commands[$command->getName()] = $command;

    foreach ($command->getAliases() as $alias) {
        $this->commands[$alias] = $command;
    }

    return $command;
}
```

**è¯´æ˜ï¼š**
- å¦‚æœ `$name` æœ‰å€¼ï¼ˆæ¯”å¦‚ 'settle:orders'ï¼‰ï¼Œç›´æ¥æ³¨å†Œåˆ° `$this->commands` æ•°ç»„
- å¦‚æœæ˜¯ç±»åå­—ç¬¦ä¸²ï¼Œé€šè¿‡ `invokeClass()` å®ä¾‹åŒ–
- è°ƒç”¨å‘½ä»¤çš„ `setName()` æ–¹æ³•è·å–å‘½ä»¤åç§°å¹¶æ³¨å†Œ

---

### 4. **Console::run() æ‰§è¡Œæµç¨‹**

**æ–‡ä»¶ä½ç½®ï¼š** `nft/vendor/topthink/framework/src/think/Console.php`

```243:279:nft/vendor/topthink/framework/src/think/Console.php
public function run()
{
    $input  = new Input();
    $output = new Output();

    $this->configureIO($input, $output);

    try {
        $exitCode = $this->doRun($input, $output);
    } catch (\Exception $e) {
        if (!$this->catchExceptions) {
            throw $e;
        }

        $output->renderException($e);

        $exitCode = $e->getCode();
        if (is_numeric($exitCode)) {
            $exitCode = (int) $exitCode;
            if (0 === $exitCode) {
                $exitCode = 1;
            }
        } else {
            $exitCode = 1;
        }
    }

    if ($this->autoExit) {
        if ($exitCode > 255) {
            $exitCode = 255;
        }

        exit($exitCode);
    }

    return $exitCode;
}
```

#### 4.1 doRun() æ–¹æ³•

```288:315:nft/vendor/topthink/framework/src/think/Console.php
public function doRun(Input $input, Output $output)
{
    if (true === $input->hasParameterOption(['--version', '-V'])) {
        $output->writeln($this->getLongVersion());

        return 0;
    }

    $name = $this->getCommandName($input);

    if (true === $input->hasParameterOption(['--help', '-h'])) {
        if (!$name) {
            $name  = 'help';
            $input = new Input(['help']);
        } else {
            $this->wantHelps = true;
        }
    }

    if (!$name) {
        $name  = $this->defaultCommand;
        $input = new Input([$this->defaultCommand]);
    }

    $command = $this->find($name);

    return $this->doRunCommand($command, $input, $output);
}
```

**è¯´æ˜ï¼š**
- ä»è¾“å…¥ä¸­è·å–å‘½ä»¤åç§°ï¼ˆ'settle:orders'ï¼‰
- è°ƒç”¨ `find()` æ–¹æ³•æŸ¥æ‰¾å‘½ä»¤
- è°ƒç”¨ `doRunCommand()` æ‰§è¡Œå‘½ä»¤

#### 4.2 find() æ–¹æ³•

```553:590:nft/vendor/topthink/framework/src/think/Console.php
public function find(string $name): Command
{
    $allCommands = array_keys($this->commands);

    $expr = preg_replace_callback('{([^:]+|)}', function ($matches) {
        return preg_quote($matches[1]) . '[^:]*';
    }, $name);

    $commands = preg_grep('{^' . $expr . '}', $allCommands);

    if (empty($commands) || count(preg_grep('{^' . $expr . '$}', $commands)) < 1) {
        if (false !== $pos = strrpos($name, ':')) {
            $this->findNamespace(substr($name, 0, $pos));
        }

        $message = sprintf('Command "%s" is not defined.', $name);

        if ($alternatives = $this->findAlternatives($name, $allCommands)) {
            if (1 == count($alternatives)) {
                $message .= "\n\nDid you mean this?\n    ";
            } else {
                $message .= "\n\nDid you mean one of these?\n    ";
            }
            $message .= implode("\n    ", $alternatives);
        }

        throw new InvalidArgumentException($message);
    }

    $exact = in_array($name, $commands, true);
    if (count($commands) > 1 && !$exact) {
        $suggestions = $this->getAbbreviationSuggestions(array_values($commands));

        throw new InvalidArgumentException(sprintf('Command "%s" is ambiguous (%s).', $name, $suggestions));
    }

    return $this->getCommand($exact ? $name : reset($commands));
}
```

#### 4.3 doRunCommand() æ–¹æ³•

```653:656:nft/vendor/topthink/framework/src/think/Console.php
protected function doRunCommand(Command $command, Input $input, Output $output)
{
    return $command->run($input, $output);
}
```

---

### 5. **SettleOrders å‘½ä»¤ç±»æ‰§è¡Œ**

**æ–‡ä»¶ä½ç½®ï¼š** `nft/app/command/SettleOrders.php`

#### 5.1 configure() æ–¹æ³• - å‘½ä»¤é…ç½®

```12:16:nft/app/command/SettleOrders.php
protected function configure()
{
    $this->setName('settle:orders')
        ->setDescription('è‡ªåŠ¨ç»“ç®—åˆ°æœŸçš„äº¤æ˜“è®¢å•');
}
```

**è¯´æ˜ï¼š**
- è®¾ç½®å‘½ä»¤åç§°ä¸º 'settle:orders'
- è®¾ç½®å‘½ä»¤æè¿°

#### 5.2 execute() æ–¹æ³• - ä¸»è¦æ‰§è¡Œé€»è¾‘

```18:55:nft/app/command/SettleOrders.php
protected function execute(Input $input, Output $output)
{
    // è¿›ç¨‹é”æ–‡ä»¶
    $lockFile = runtime_path() . 'settle_orders.lock';

    // æ£€æŸ¥æ˜¯å¦å·²æœ‰è¿›ç¨‹åœ¨è¿è¡Œ
    if (file_exists($lockFile)) {
        $pid = file_get_contents($lockFile);
        // æ£€æŸ¥è¿›ç¨‹æ˜¯å¦è¿˜åœ¨è¿è¡Œï¼ˆLinuxï¼‰
        if (file_exists("/proc/{$pid}")) {
            $output->writeln('å·²æœ‰ç»“ç®—è¿›ç¨‹åœ¨è¿è¡Œï¼Œé€€å‡º');
            return 0;
        }
    }

    // å†™å…¥å½“å‰è¿›ç¨‹ID
    file_put_contents($lockFile, getmypid());

    $output->writeln('å¼€å§‹è®¢å•ç»“ç®—å®ˆæŠ¤è¿›ç¨‹ï¼ˆè¿è¡Œ60ç§’ï¼‰...');

    try {
        // è¿è¡Œ60ç§’ï¼Œæ¯ç§’æ£€æŸ¥ä¸€æ¬¡
        for ($i = 0; $i < 60; $i++) {
            $this->settleExpiredOrders($output);

            // æœ€åä¸€æ¬¡ä¸éœ€è¦ç­‰å¾…
            if ($i < 59) {
                sleep(1);
            }
        }
    } finally {
        // åˆ é™¤é”æ–‡ä»¶
        @unlink($lockFile);
    }

    $output->writeln('æœ¬è½®ç»“ç®—å®Œæˆ');
    return 0;
}
```

**è¯´æ˜ï¼š**
- è¿™æ˜¯å‘½ä»¤çš„ä¸»è¦æ‰§è¡Œæ–¹æ³•
- å®ç°è¿›ç¨‹é”æœºåˆ¶
- è¿è¡Œ 60 ç§’ï¼Œæ¯ç§’æ£€æŸ¥ä¸€æ¬¡åˆ°æœŸè®¢å•
- è°ƒç”¨ `settleExpiredOrders()` æ–¹æ³•å¤„ç†è®¢å•

#### 5.3 settleExpiredOrders() æ–¹æ³• - è®¢å•ç»“ç®—é€»è¾‘

```60:202:nft/app/command/SettleOrders.php
private function settleExpiredOrders(Output $output)
{
    // è·å–æ‰€æœ‰åˆ°æœŸä½†æœªç»“ç®—çš„è®¢å•
    $expiredOrders = Db::name('trade_orders')
        ->whereIn('status', [0, 1])
        ->where('expired_at', '<=', date('Y-m-d H:i:s'))
        ->select()
        ->toArray();

    if (empty($expiredOrders)) {
        $output->writeln(date('H:i:s') . ' - æ— åˆ°æœŸè®¢å•');
        return;
    }

    $output->writeln(date('H:i:s') . ' - æ‰¾åˆ° ' . count($expiredOrders) . ' ä¸ªåˆ°æœŸè®¢å•');

    $settledCount = 0;
    $now = date('Y-m-d H:i:s');

    foreach ($expiredOrders as $order) {
        // ... è®¢å•ç»“ç®—é€»è¾‘
    }

    if ($settledCount > 0) {
        $output->writeln("ç»“ç®—å®Œæˆï¼Œå…±ç»“ç®— {$settledCount} ä¸ªè®¢å•");
    }
}
```

---

## ğŸ“ å…³é”®ä»£ç æ–‡ä»¶æ€»ç»“

| æ–‡ä»¶è·¯å¾„ | ä½œç”¨ |
|---------|------|
| `nft/think` | **å…¥å£æ–‡ä»¶**ï¼Œå‘½ä»¤è¡Œæ‰§è¡Œçš„èµ·ç‚¹ |
| `nft/config/console.php` | **å‘½ä»¤æ³¨å†Œé…ç½®**ï¼Œå®šä¹‰è‡ªå®šä¹‰å‘½ä»¤ |
| `nft/app/command/SettleOrders.php` | **å‘½ä»¤å®ç°ç±»**ï¼Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘ |
| `nft/vendor/topthink/framework/src/think/Console.php` | **æ¡†æ¶æ ¸å¿ƒç±»**ï¼Œå‘½ä»¤åŠ è½½å’Œæ‰§è¡Œè°ƒåº¦ |

---

## ğŸ”— è°ƒç”¨é“¾

```
think (å…¥å£)
  â†’ App::__construct()
    â†’ Console::__construct()
      â†’ Console::loadCommands()
        â†’ Console::addCommands()
          â†’ Console::addCommand()
            â†’ æ³¨å†Œ 'settle:orders' => SettleOrders::class
  â†’ Console::run()
    â†’ Console::doRun()
      â†’ Console::find('settle:orders')
        â†’ Console::getCommand('settle:orders')
          â†’ è¿”å› SettleOrders å®ä¾‹
      â†’ Console::doRunCommand()
        â†’ SettleOrders::run()
          â†’ SettleOrders::execute()
            â†’ settleExpiredOrders()
              â†’ è®¢å•ç»“ç®—ä¸šåŠ¡é€»è¾‘
```

---

## ğŸ’¡ å¦‚ä½•æŸ¥æ‰¾å‘½ä»¤ä»£ç 

1. **æŸ¥æ‰¾å…¥å£æ–‡ä»¶ï¼š** `nft/think`
2. **æŸ¥æ‰¾å‘½ä»¤é…ç½®ï¼š** `nft/config/console.php`
3. **æŸ¥æ‰¾å‘½ä»¤å®ç°ï¼š** `nft/app/command/SettleOrders.php`
4. **æŸ¥æ‰¾æ¡†æ¶é€»è¾‘ï¼š** `nft/vendor/topthink/framework/src/think/Console.php`

